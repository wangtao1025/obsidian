# AI 课程：BM25（rank_bm25）

本文对应课程 [rag.docs-hub.com](https://rag.docs-hub.com/) 中的 **rank_bm25** 文档，归在 **AI 分类**（检索与排序）。BM25（Best Match 25）是基于 TF-IDF 改进的概率相关性评分算法，用于计算查询与文档的相关性得分；无需训练，适合搜索引擎、问答与文档检索。可与 [词袋模型（BagofWords）](/ai/AI课程-BagofWords)、[TF-IDF](/ai/AI课程-TF-IDF)、[RAG 与向量基础](/ai/AI课程-RAG与向量基础)、[jieba](/python/AI课程-jieba) 搭配学习。

---

## 1. 什么是 BM25？为什么需要？

- **是什么**：Okapi BM25，用数学公式计算查询与文档的相关性分数；基于词频（TF）、逆文档频率（IDF）、文档长度归一化与词频饱和度。
- **为什么需要**：从大量文档中找与查询最相关的文档；能区分重要词与停用词、处理词频与文档长度影响，比简单“是否包含词”更合理。
- **特点**：无需训练、经典且效果稳定、计算高效，适合大规模检索。

---

## 2. 前置概念（简要）

| 概念 | 说明 |
|------|------|
| **TF** | 词在文档中的出现次数；同一词出现越多，文档与该词越可能相关。 |
| **DF** | 包含该词的文档数；越少则词区分度越高。 |
| **IDF** | 逆文档频率，衡量词稀有程度；BM25 中常用 log((N−df+0.5)/(df+0.5))+1。 |
| **TF-IDF** | TF×IDF，词在文档中多且整体稀有则权重高。 |
| **长度归一化** | 避免长文档因词多而占优；BM25 用 1−b+b×(文档长度/平均长度)，b 常用 0.75。 |
| **词频饱和度** | 词频增加对分数的贡献非线性、逐渐饱和；由 k1 控制（常用 1.5）。 |

---

## 3. 核心思想与公式要点

- **核心**：词在文档中出现越多、在集合中越稀有，对该文档相关性贡献越大；同时做长度归一化与词频饱和。
- **公式**：对查询中每个词，分数贡献 = IDF(词) × 调整后 TF；调整后 TF = (tf×(k1+1)) / (tf + k1×归一化项)；文档总分为各词贡献之和。
- **参数**：**k1**（词频饱和度，1.2～2.0，默认 1.5）；**b**（长度归一化，0～1，默认 0.75）。

---

## 4. 实现与使用

- **手写**：预计算 N、平均文档长度、每词 DF 与 IDF；对查询分词后对每文档累加各词的 BM25 贡献。
- **库**：`rank_bm25` 的 `BM25Okapi`：传入已分词文档列表，`get_scores(query_tokens)`、`get_top_n(query_tokens, documents, n)`。
- **中文**：BM25 与语言无关，需先分词（如 [jieba](/python/AI课程-jieba)），再对词列表做 BM25。

---

## 5. BM25 vs TF-IDF

| 方面 | TF-IDF | BM25 |
|------|--------|------|
| 词频 | 线性增长 | 非线性饱和 |
| 长度归一化 | 如余弦归一化 | 参数 b 可调 |
| 参数 | 无 | k1、b |
| 效果 | 基础有效 | 通常更鲁棒 |

**何时用 BM25**：需要更好检索效果、大规模检索、生产环境。**何时用 TF-IDF**：简单快速检索、不需调参、作基线。

---

## 6. 局限与建议

- **局限**：词袋模型不考虑词序；只看字面匹配不考虑语义；未登录词无法得分。
- **建议**：默认 k1=1.5、b=0.75；中文先分词；可与向量检索/语义检索结合（如 RAG 中 BM25+向量混合）。

---

**相关文档**：[词袋模型（BagofWords）](/ai/AI课程-BagofWords) · [TF-IDF](/ai/AI课程-TF-IDF) · [RAG 与向量基础](/ai/AI课程-RAG与向量基础) · [MMR](/ai/AI课程-MMR) · [jieba](/python/AI课程-jieba) · [Scikit-learn](/python/AI课程-scikit-learn)（TfidfVectorizer）· [知识体系与学习路径](/ai/知识体系与学习路径) · [rank_bm25（课程原文）](https://rag.docs-hub.com/html/rank_bm25.html)
